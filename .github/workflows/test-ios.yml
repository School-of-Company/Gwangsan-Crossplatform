name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-ios:
    name: iOS E2E Test
    runs-on: macos-latest
    timeout-minutes: 300

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: sudo gem install cocoapods -v 1.15.2

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Setup Xcode (pin)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Create & boot iOS Simulator (robust)
        id: simulator
        shell: bash
        run: |
          set -eu
          xcrun simctl list runtimes
          xcrun simctl list devices

          ALL_IOS_IDS=$(xcrun simctl list runtimes | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9]+-[0-9]+' || true)
          if [ -z "${ALL_IOS_IDS:-}" ]; then
            echo "No iOS runtimes installed."
            exit 1
          fi

          ALL_VERS=$(echo "$ALL_IOS_IDS" | sed -E 's/.*iOS-([0-9]+)-([0-9]+)/\1.\2/' | sort -V || true)
          BEST_VER=$(echo "$ALL_VERS" | tail -1 || true)

          if [ -z "${BEST_VER:-}" ]; then
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          else
            WANT=$(echo "$BEST_VER" | sed -E 's/([0-9]+)\.([0-9]+)/\1-\2/')
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | grep "iOS-${WANT}" | head -1 || true)
            [ -z "${RUNTIME_ID:-}" ] && RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          fi
          echo "Using runtime: $RUNTIME_ID"

          DEVICE_NAME="CI-iPhone-15"
          EXISTING=$(xcrun simctl list devices | grep "$DEVICE_NAME" | awk -F '[()]' '{print $2}' | head -1 || true)
          if [ -n "${EXISTING:-}" ]; then
            xcrun simctl delete "$EXISTING" || true
          fi

          SIM_ID=$(xcrun simctl create "$DEVICE_NAME" "iPhone 15" "$RUNTIME_ID")
          echo "Created simulator: $SIM_ID"

          xcrun simctl boot "$SIM_ID" || true
          xcrun simctl bootstatus "$SIM_ID" -b
          sleep 10

          echo "device_udid=$SIM_ID" >> "$GITHUB_OUTPUT"
          echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"

      - name: Prebuild iOS project
        run: |
          set -e
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          set -e
          # echo "Pods Ï∫êÏãú ÏßÄÏö∏Í≤å~"
          # rm -rf Pods
          # rm -f Podfile.lock
          # rm -rf ~/Library/Caches/CocoaPods
          # rm -rf ~/Library/Developer/Xcode/DerivedData/*

          pod repo update || true
          pod install --repo-update

          if [ ! -d "Pods" ]; then
            echo "Pods directory not found after installation"
            exit 1
          fi
          echo "Pods installed successfully"

      - name: Verify workspace setup
        working-directory: ios
        run: |
          set -e
          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "xcworkspace not found"
            exit 1
          fi

          xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 20 "Schemes:" || true

          if [ -d "Pods" ]; then
            find Pods -name "*.modulemap" -o -name "*.podspec" | head -20 || true
          fi

          if [ -d "Pods/Pods.xcodeproj" ]; then
            xcodebuild -list -project "Pods/Pods.xcodeproj" 2>/dev/null | grep -A 50 "Targets:" || true
          fi

          if [ -f "Podfile.properties.json" ]; then
            cat Podfile.properties.json
          fi

      - name: Prepare build environment
        working-directory: ios
        id: build-prep
        run: |
          set -e
          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "xcworkspace not found"
            ls -la
            exit 1
          fi

          WORKSPACE_PATH=$(realpath "$WORKSPACE_PATH" || echo "$WORKSPACE_PATH")
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs || echo "app")

          DEVICE_UDID="${{ steps.simulator.outputs.device_udid }}"
          if [ -z "$DEVICE_UDID" ]; then
            echo "no simulator UDID from previous step"
            exit 1
          fi

          if [ -d "Pods" ]; then
            echo "Pods directory exists"
          else
            echo "Pods directory not found"
            exit 1
          fi

          if [ -d "Pods/Pods.xcodeproj" ]; then
            echo "Pods.xcodeproj exists"
          else
            echo "Pods.xcodeproj not found"
            exit 1
          fi

          DERIVED_DATA_PATH="$HOME/Library/Developer/Xcode/DerivedData/ci-build"
          echo "workspace_path=$WORKSPACE_PATH" >> "$GITHUB_OUTPUT"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"
          echo "device_udid=$DEVICE_UDID" >> "$GITHUB_OUTPUT"
          echo "derived_data_path=$DERIVED_DATA_PATH" >> "$GITHUB_OUTPUT"

          echo "Workspace: $WORKSPACE_PATH"
          echo "Scheme: $SCHEME"
          echo "Device UDID: $DEVICE_UDID"
          echo "DerivedData: $DERIVED_DATA_PATH"

      - name: Clean DerivedData
        working-directory: ios
        run: |
          set -e
          DERIVED_DATA_PATH="${{ steps.build-prep.outputs.derived_data_path }}"

          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          mkdir -p "$DERIVED_DATA_PATH"
          echo "DerivedData cleaned, using: $DERIVED_DATA_PATH"

      - name: Verify workspace schemes
        working-directory: ios
        run: |
          set -e
          WORKSPACE_PATH="${{ steps.build-prep.outputs.workspace_path }}"

          xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 50 "Schemes:" || true

      - name: Build Pods dependencies
        working-directory: ios
        run: |
          set -e
          DERIVED_DATA_PATH="${{ steps.build-prep.outputs.derived_data_path }}"

          echo "Building Pods-app aggregate target from Pods.xcodeproj"
          echo "Note: -project doesn't support -derivedDataPath, so we'll use default DerivedData"
          echo "and copy the results to our custom DerivedData path"
          echo ""

          xcodebuild -project "Pods/Pods.xcodeproj" \
            -target "Pods-app" \
            -configuration Debug \
            -sdk iphonesimulator \
            ARCHS="arm64" \
            "EXCLUDED_ARCHS[sdk=iphonesimulator*]=x86_64" \
            ONLY_ACTIVE_ARCH=YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ASSETCATALOG_COMPILER_SKIP_APP_STORE_DEPLOYMENT=YES \
            ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO \
            -jobs 1 \
            build 2>&1 | tee /tmp/pods-build.log

          PODS_BUILD_EXIT_CODE=${PIPESTATUS[0]}

          if [ "$PODS_BUILD_EXIT_CODE" -ne 0 ]; then
            echo "ERROR: Pods build failed with exit code $PODS_BUILD_EXIT_CODE"
            echo "Pods build errors:"
            grep -i "error:\|BUILD FAILED\|failed with a nonzero exit code" /tmp/pods-build.log | head -30 || true
            exit 1
          fi

          echo ""
          echo "‚úì Pods build completed successfully"

          DEFAULT_DD=$(find ~/Library/Developer/Xcode/DerivedData -maxdepth 1 -type d -name "Pods-*" 2>/dev/null | head -1 || echo "")

          if [ -z "$DEFAULT_DD" ]; then
            echo "ERROR: Could not find Pods build output in default DerivedData"
            echo "Searching all DerivedData directories:"
            ls -la ~/Library/Developer/Xcode/DerivedData/ | head -20 || true
            exit 1
          fi

          DEFAULT_PRODUCTS="$DEFAULT_DD/Build/Products/Debug-iphonesimulator"

          if [ ! -d "$DEFAULT_PRODUCTS" ]; then
            echo "ERROR: Pods products directory not found: $DEFAULT_PRODUCTS"
            echo "Checking build log for clues..."
            grep -i "building.*target\|BUILD SUCCEEDED" /tmp/pods-build.log | tail -20 || true
            exit 1
          fi

          FRAMEWORKS=$(find "$DEFAULT_PRODUCTS" -name "*.framework" -type d 2>/dev/null | wc -l | tr -d ' ')
          MODULEMAPS_STANDALONE=$(find "$DEFAULT_PRODUCTS" -name "*.modulemap" -not -path "*.framework/*" 2>/dev/null | wc -l | tr -d ' ')
          MODULEMAPS_IN_FRAMEWORKS=$(find "$DEFAULT_PRODUCTS" -name "*.modulemap" -path "*.framework/*" 2>/dev/null | wc -l | tr -d ' ')
          TOTAL_MODULEMAPS=$((MODULEMAPS_STANDALONE + MODULEMAPS_IN_FRAMEWORKS))

          echo "Pods build verification (from default DerivedData):"
          echo "  Location: $DEFAULT_PRODUCTS"
          echo "  Frameworks: $FRAMEWORKS"
          echo "  Standalone modulemaps: $MODULEMAPS_STANDALONE"
          echo "  Modulemaps in frameworks: $MODULEMAPS_IN_FRAMEWORKS"
          echo "  Total modulemaps: $TOTAL_MODULEMAPS"

          if [ "$FRAMEWORKS" -eq 0 ] && [ "$TOTAL_MODULEMAPS" -eq 0 ]; then
            echo "ERROR: No Pods products found after build"
            echo "This indicates Pods were not built correctly"
            echo "Checking build log for clues..."
            grep -i "framework\|modulemap\|building.*target" /tmp/pods-build.log | head -30 || true
            exit 1
          fi

          echo ""
          echo "Copying Pods to custom DerivedData for app build..."
          CUSTOM_PRODUCTS="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
          mkdir -p "$CUSTOM_PRODUCTS"

          cp -R "$DEFAULT_PRODUCTS"/* "$CUSTOM_PRODUCTS/" 2>/dev/null || {
            echo "WARNING: Some files may not have been copied"
            find "$DEFAULT_PRODUCTS" -name "*.framework" -type d -exec cp -R {} "$CUSTOM_PRODUCTS/" \; 2>/dev/null || true
            find "$DEFAULT_PRODUCTS" -name "*.modulemap" -exec cp {} "$CUSTOM_PRODUCTS/" \; 2>/dev/null || true
          }

          COPIED_FRAMEWORKS=$(find "$CUSTOM_PRODUCTS" -name "*.framework" -type d 2>/dev/null | wc -l | tr -d ' ')
          COPIED_MODULEMAPS=$(find "$CUSTOM_PRODUCTS" -name "*.modulemap" 2>/dev/null | wc -l | tr -d ' ')

          echo "‚úì Pods copied to custom DerivedData"
          echo "  Frameworks copied: $COPIED_FRAMEWORKS"
          echo "  Modulemaps copied: $COPIED_MODULEMAPS"

          if [ "$COPIED_FRAMEWORKS" -gt 0 ] || [ "$COPIED_MODULEMAPS" -gt 0 ]; then
            echo "‚úì Pods ready for app build: $COPIED_FRAMEWORKS frameworks, $COPIED_MODULEMAPS modulemaps"
            
            if [ "$COPIED_FRAMEWORKS" -gt 0 ]; then
              echo "Sample frameworks (first 5):"
              find "$CUSTOM_PRODUCTS" -name "*.framework" -type d 2>/dev/null | head -5 || true
            fi
            if [ "$COPIED_MODULEMAPS" -gt 0 ]; then
              echo "Sample modulemaps (first 5):"
              find "$CUSTOM_PRODUCTS" -name "*.modulemap" 2>/dev/null | head -5 || true
            fi
          else
            echo "ERROR: Failed to copy Pods to custom DerivedData"
            exit 1
          fi

      - name: Build iOS app
        working-directory: ios
        run: |
          set -e
          WORKSPACE_PATH="${{ steps.build-prep.outputs.workspace_path }}"
          SCHEME="${{ steps.build-prep.outputs.scheme }}"
          DEVICE_UDID="${{ steps.build-prep.outputs.device_udid }}"
          DERIVED_DATA_PATH="${{ steps.build-prep.outputs.derived_data_path }}"

          xcodebuild -workspace "$WORKSPACE_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=$DEVICE_UDID" \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            ARCHS="arm64" \
            "EXCLUDED_ARCHS[sdk=iphonesimulator*]=x86_64" \
            ONLY_ACTIVE_ARCH=YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ASSETCATALOG_COMPILER_SKIP_APP_STORE_DEPLOYMENT=YES \
            ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS=NO \
            -jobs 1 \
            build 2>&1 | tee /tmp/xcodebuild.log

          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "$BUILD_EXIT_CODE" > /tmp/build_exit_code.txt

      - name: Verify build results
        working-directory: ios
        run: |
          set -e
          DERIVED_DATA_PATH="${{ steps.build-prep.outputs.derived_data_path }}"
          BUILD_EXIT_CODE=$(cat /tmp/build_exit_code.txt 2>/dev/null || echo "1")

          echo "Checking if Pods were built and modulemaps exist..."

          PRODUCTS_DIR="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
          if [ -d "$PRODUCTS_DIR" ]; then
            FRAMEWORKS=$(find "$PRODUCTS_DIR" -name "*.framework" -type d 2>/dev/null | wc -l | tr -d ' ')
            MODULEMAPS_STANDALONE=$(find "$PRODUCTS_DIR" -name "*.modulemap" -not -path "*.framework/*" 2>/dev/null | wc -l | tr -d ' ')
            MODULEMAPS_IN_FRAMEWORKS=$(find "$PRODUCTS_DIR" -name "*.modulemap" -path "*.framework/*" 2>/dev/null | wc -l | tr -d ' ')
            TOTAL_MODULEMAPS=$((MODULEMAPS_STANDALONE + MODULEMAPS_IN_FRAMEWORKS))
            
            echo "Found $FRAMEWORKS frameworks"
            echo "Found $MODULEMAPS_STANDALONE standalone modulemaps"
            echo "Found $MODULEMAPS_IN_FRAMEWORKS modulemaps inside frameworks"
            echo "Total modulemaps: $TOTAL_MODULEMAPS"
            
            if [ "$TOTAL_MODULEMAPS" -eq 0 ]; then
              echo "‚ö† WARNING: No modulemaps found in products directory"
              echo "This may cause build failures"
              echo "Listing frameworks:"
              find "$PRODUCTS_DIR" -name "*.framework" -type d 2>/dev/null | head -10 || true
              echo ""
              echo "Checking framework structure (first 3):"
              for FW in $(find "$PRODUCTS_DIR" -name "*.framework" -type d 2>/dev/null | head -3); do
                echo "Framework: $FW"
                ls -la "$FW" | head -10 || true
                if [ -f "$FW/Modules/module.modulemap" ]; then
                  echo "  ‚úì Found module.modulemap inside framework"
                else
                  echo "  ‚úó No module.modulemap found inside framework"
                fi
              done
            else
              echo "‚úì Modulemaps found"
              if [ "$MODULEMAPS_STANDALONE" -gt 0 ]; then
                echo "Standalone modulemaps (first 5):"
                find "$PRODUCTS_DIR" -name "*.modulemap" -not -path "*.framework/*" 2>/dev/null | head -5 || true
              fi
              if [ "$MODULEMAPS_IN_FRAMEWORKS" -gt 0 ]; then
                echo "Modulemaps in frameworks (first 5):"
                find "$PRODUCTS_DIR" -name "*.modulemap" -path "*.framework/*" 2>/dev/null | head -5 || true
              fi
            fi
          else
            echo "‚ö† Products directory not found: $PRODUCTS_DIR"
          fi

          if grep -qi "module map file.*not found\|no such module" /tmp/xcodebuild.log; then
            echo ""
            echo "ERROR: Module import errors detected - build cannot succeed"
            echo "This indicates Pods dependencies were not built correctly"
            echo ""
            echo "Module errors:"
            grep -i "module map file.*not found\|no such module" /tmp/xcodebuild.log | head -30 || true
            echo ""
            echo "Debugging information:"
            echo "DerivedData path: $DERIVED_DATA_PATH"
            echo "Checking all DerivedData directories:"
            for DD_DIR in ~/Library/Developer/Xcode/DerivedData/*/Build/Products/Debug-iphonesimulator; do
              if [ -d "$DD_DIR" ]; then
                echo "Found: $DD_DIR"
                MODULEMAP_COUNT=$(find "$DD_DIR" -name "*.modulemap" 2>/dev/null | wc -l | tr -d ' ')
                echo "  Modulemaps: $MODULEMAP_COUNT"
                if [ "$MODULEMAP_COUNT" -gt 0 ]; then
                  find "$DD_DIR" -name "*.modulemap" 2>/dev/null | head -5
                fi
              fi
            done
            echo ""
            echo "Checking if Pods were built:"
            grep -i "building.*pods\|pods.*build" /tmp/xcodebuild.log | head -10 || echo "No Pods build messages found"
            exit 1
          fi

          if [ "$BUILD_EXIT_CODE" -ne 0 ]; then
            echo ""
            echo "Build failed with exit code $BUILD_EXIT_CODE"
            echo "Swift/compilation errors:"
            grep -i "error:" /tmp/xcodebuild.log | grep -v "note:" | head -30 || true
            echo ""
            echo "Checking build log for Pods-related issues:"
            grep -i "pods\|framework\|module" /tmp/xcodebuild.log | grep -i "error\|fail" | head -20 || true
            exit 1
          fi

          if grep -qi "BUILD FAILED\|failed with a nonzero exit code" /tmp/xcodebuild.log; then
            echo ""
            echo "WARNING: Build failures detected in log"
            grep -i "BUILD FAILED\|failed with a nonzero exit code" /tmp/xcodebuild.log | head -10 || true
            exit 1
          fi

          echo ""
          echo "‚úì Build completed successfully"

      - name: Verify app bundle
        working-directory: ios
        run: |
          set -e
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" 2>/dev/null | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "Error: App not found in build output"
            echo "Searching in all DerivedData directories:"
            find ~/Library/Developer/Xcode/DerivedData -name "*.app" 2>/dev/null | head -10 || true
            exit 1
          fi

          echo "Found app at: $APP_PATH"
          echo "Verifying app bundle structure..."

          APP_NAME=$(basename "$APP_PATH" .app)
          EXECUTABLE_PATH="$APP_PATH/$APP_NAME"

          if [ ! -f "$EXECUTABLE_PATH" ]; then
            echo "ERROR: Executable not found at expected path: $EXECUTABLE_PATH"
            echo "App bundle contents:"
            ls -la "$APP_PATH" || true
            echo "Looking for any executable files:"
            find "$APP_PATH" -type f -perm +111 2>/dev/null || true
            echo "Checking Info.plist for executable name:"
            if [ -f "$APP_PATH/Info.plist" ]; then
              /usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_PATH/Info.plist" 2>/dev/null || true
            fi
            exit 1
          fi

          if [ ! -x "$EXECUTABLE_PATH" ]; then
            echo "ERROR: Executable exists but is not executable"
            ls -la "$EXECUTABLE_PATH"
            exit 1
          fi

          echo "App bundle verification successful"
          echo "Executable: $EXECUTABLE_PATH"
          echo "Executable size: $(stat -f%z "$EXECUTABLE_PATH" 2>/dev/null || stat -c%s "$EXECUTABLE_PATH" 2>/dev/null) bytes"
          file "$EXECUTABLE_PATH" || true

      - name: Install app on simulator
        working-directory: ios
        run: |
          set -e
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" 2>/dev/null | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" 2>/dev/null | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "Error: App not found"
            exit 1
          fi

          echo "Installing app: $APP_PATH"
          xcrun simctl install booted "$APP_PATH"

      - name: Run Maestro tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [test-ios]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not set, skipping notification"
            exit 0
          fi

          IOS_STATUS="${{ needs.test-ios.result }}"

          if [ "$IOS_STATUS" == "success" ] || [ "$IOS_STATUS" == "skipped" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="‚ùå"
            STATUS="Ïã§Ìå®"
          fi

          EMBED=$(cat <<EOF
          {
            "title": "$EMOJI Maestro ÌÖåÏä§Ìä∏ $STATUS",
            "color": $COLOR,
            "fields": [
              {"name": "iOS", "value": "$IOS_STATUS", "inline": true},
              {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[Î≥¥Í∏∞]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)", "inline": false}
            ]
          }
          EOF
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [$EMBED]}"

          if [ "$STATUS" == "Ïã§Ìå®" ]; then
            IOS_SCREENSHOT=$(find maestro-results-ios -name "*.png" 2>/dev/null | head -1)
            
            [ -n "$IOS_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$IOS_SCREENSHOT" -F "content=üçé iOS Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
          fi
      - name: Xcode/SDK info
        run: |
          xcodebuild -version
          xcodebuild -showsdks
          xcrun simctl list

      - name: Print DerivedData products
        if: failure()
        run: |
          find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "*.app" -print
