name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-android:
    name: Android E2E Test
    runs-on: macos-13
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: Nexus 6
          script: |
            export PATH="$PATH:$HOME/.maestro/bin"
            
            echo "Resetting ADB connection..."
            adb kill-server
            sleep 2
            adb start-server
            sleep 2
            
            echo "Waiting for emulator to be fully booted..."
            adb wait-for-device
            sleep 5
            
            TIMEOUT=240
            ELAPSED=0
            while true; do
              # Check if device is online
              DEVICE_STATUS=$(adb devices | grep emulator | awk '{print $2}' || echo "")
              if [ "$DEVICE_STATUS" != "device" ]; then
                echo "Device status: $DEVICE_STATUS (waiting for 'device' status)..."
                sleep 5
                ELAPSED=$((ELAPSED + 5))
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "Timeout waiting for device to be online (${TIMEOUT}s)"
                  adb devices
                  exit 1
                fi
                continue
              fi
              
              # Check boot completion
              BOOT_COMPLETED=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
              if [ "$BOOT_COMPLETED" = "1" ]; then
                echo "Emulator is ready (boot completed)"
                break
              fi
              
              if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "Timeout waiting for emulator to boot (${TIMEOUT}s)"
                adb devices
                adb shell getprop sys.boot_completed
                exit 1
              fi
              
              echo "Waiting for boot to complete... ($ELAPSED/$TIMEOUT seconds)"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            
            echo "Emulator is fully ready, waiting additional 10 seconds..."
            sleep 10
            adb shell input keyevent 82

            echo "Building and installing app..."
            npx expo prebuild --platform android --clean
            cd android
            ./gradlew assembleDebug

            APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
            if [ -z "$APK_PATH" ]; then
              APK_PATH=$(find . -name "app-debug.apk" | head -1)
            fi

            if [ -n "$APK_PATH" ]; then
              echo "Installing APK: $APK_PATH"
              adb install -r "$APK_PATH"
            else
              echo "APK not found"
              exit 1
            fi

            sleep 5

            maestro test ../maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-android
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  test-ios:
    name: iOS E2E Test
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Start iOS Simulator
        id: simulator
        run: |
          xcrun simctl list devices available
          
          DEVICE=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed 's/.*(\(.*\))/\1/' | xargs || echo "iPhone 15")
          echo "Booting device: $DEVICE"
          xcrun simctl boot "$DEVICE" || true
          
          DEVICE_UDID=$(xcrun simctl list devices | grep "$DEVICE" | grep Booted | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          if [ -z "$DEVICE_UDID" ]; then
            DEVICE_UDID=$(xcrun simctl list devices | grep "$DEVICE" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          fi
          
          echo "device_udid=$DEVICE_UDID" >> $GITHUB_OUTPUT
          echo "device_name=$DEVICE" >> $GITHUB_OUTPUT
          
          sleep 10

      - name: Build and install iOS app
        run: |
          npx expo prebuild --platform ios --clean
          cd ios

          pod install

          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: xcworkspace not found"
            ls -la
            exit 1
          fi
          
          WORKSPACE_PATH=$(realpath "$WORKSPACE_PATH" || echo "$WORKSPACE_PATH")
          WORKSPACE=$(basename "$WORKSPACE_PATH" .xcworkspace)
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs || echo "$WORKSPACE")
          
          echo "Found workspace: $WORKSPACE_PATH"

          DEVICE_UDID="${{ steps.simulator.outputs.device_udid }}"
          if [ -z "$DEVICE_UDID" ]; then
            DEVICE_UDID=$(xcrun simctl list devices | grep Booted | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
          fi
          
          echo "Building workspace: $WORKSPACE_PATH, scheme: $SCHEME, destination: $DEVICE_UDID"
          
          xcodebuild -workspace "$WORKSPACE_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=$DEVICE_UDID" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build

          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi

          if [ -n "$APP_PATH" ]; then
            echo "Installing app: $APP_PATH"
            xcrun simctl install booted "$APP_PATH"
          else
            echo "Error: App not found in build output"
            exit 1
          fi

      - name: Run Maestro tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [test-android, test-ios]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not set, skipping notification"
            exit 0
          fi

          ANDROID_STATUS="${{ needs.test-android.result }}"
          IOS_STATUS="${{ needs.test-ios.result }}"

          if [ "$ANDROID_STATUS" == "success" ] && ([ "$IOS_STATUS" == "success" ] || [ "$IOS_STATUS" == "skipped" ]); then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          elif ([ "$ANDROID_STATUS" == "success" ] || [ "$ANDROID_STATUS" == "skipped" ]) && [ "$IOS_STATUS" == "success" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="‚ùå"
            STATUS="Ïã§Ìå®"
          fi

          EMBED=$(cat <<EOF
          {
            "title": "$EMOJI Maestro ÌÖåÏä§Ìä∏ $STATUS",
            "color": $COLOR,
            "fields": [
              {"name": "Android", "value": "$ANDROID_STATUS", "inline": true},
              {"name": "iOS", "value": "$IOS_STATUS", "inline": true},
              {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[Î≥¥Í∏∞]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)", "inline": false}
            ]
          }
          EOF
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [$EMBED]}"

          if [ "$STATUS" == "Ïã§Ìå®" ]; then
            ANDROID_SCREENSHOT=$(find maestro-results-android -name "*.png" 2>/dev/null | head -1)
            IOS_SCREENSHOT=$(find maestro-results-ios -name "*.png" 2>/dev/null | head -1)
            
            [ -n "$ANDROID_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$ANDROID_SCREENSHOT" -F "content=üì± Android Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
            
            [ -n "$IOS_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$IOS_SCREENSHOT" -F "content=üçé iOS Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
          fi
