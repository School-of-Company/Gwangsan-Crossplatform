name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-android:
    name: Android E2E Test
    runs-on: macos-13
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Start Android Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: Nexus 6
          script: |
            export PATH="$PATH:$HOME/.maestro/bin"

            echo "Building and installing app..."
            npx expo prebuild --platform android --clean
            cd android
            ./gradlew assembleDebug

            APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
            if [ -z "$APK_PATH" ]; then
              APK_PATH=$(find . -name "app-debug.apk" | head -1)
            fi

            if [ -n "$APK_PATH" ]; then
              echo "Installing APK: $APK_PATH"
              adb install -r "$APK_PATH"
            else
              echo "APK not found"
              exit 1
            fi

            adb wait-for-device
            sleep 5
            adb shell input keyevent 82

            maestro test ../maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-android
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  test-ios:
    name: iOS E2E Test
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Start iOS Simulator
        run: |
          xcrun simctl list devices available

          DEVICE=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | sed 's/.*(\(.*\))/\1/' | xargs || echo "iPhone 15")
          echo "Booting device: $DEVICE"
          xcrun simctl boot "$DEVICE" || true

          sleep 10

      - name: Build and install iOS app
        run: |
          npx expo prebuild --platform ios --clean
          cd ios

          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: xcworkspace not found"
            exit 1
          fi

          WORKSPACE=$(basename "$WORKSPACE_PATH" .xcworkspace)
          echo "Found workspace: $WORKSPACE_PATH"

          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
          if [ -z "$SCHEME" ]; then
            SCHEME="$WORKSPACE"
          fi

          echo "Building workspace: $WORKSPACE_PATH, scheme: $SCHEME"

          xcodebuild -workspace "$WORKSPACE_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath ./build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO

          APP_PATH=$(find ./build/Build/Products/Debug-iphonesimulator -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            xcrun simctl install booted "$APP_PATH"
          else
            echo "Error: App not found in build output"
            exit 1
          fi

      - name: Run Maestro tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [test-android, test-ios]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not set, skipping notification"
            exit 0
          fi

          ANDROID_STATUS="${{ needs.test-android.result }}"
          IOS_STATUS="${{ needs.test-ios.result }}"

          if [ "$ANDROID_STATUS" == "success" ] && ([ "$IOS_STATUS" == "success" ] || [ "$IOS_STATUS" == "skipped" ]); then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          elif ([ "$ANDROID_STATUS" == "success" ] || [ "$ANDROID_STATUS" == "skipped" ]) && [ "$IOS_STATUS" == "success" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="‚ùå"
            STATUS="Ïã§Ìå®"
          fi

          EMBED=$(cat <<EOF
          {
            "title": "$EMOJI Maestro ÌÖåÏä§Ìä∏ $STATUS",
            "color": $COLOR,
            "fields": [
              {"name": "Android", "value": "$ANDROID_STATUS", "inline": true},
              {"name": "iOS", "value": "$IOS_STATUS", "inline": true},
              {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[Î≥¥Í∏∞]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)", "inline": false}
            ]
          }
          EOF
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [$EMBED]}"

          if [ "$STATUS" == "Ïã§Ìå®" ]; then
            ANDROID_SCREENSHOT=$(find maestro-results-android -name "*.png" 2>/dev/null | head -1)
            IOS_SCREENSHOT=$(find maestro-results-ios -name "*.png" 2>/dev/null | head -1)
            
            [ -n "$ANDROID_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$ANDROID_SCREENSHOT" -F "content=üì± Android Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
            
            [ -n "$IOS_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$IOS_SCREENSHOT" -F "content=üçé iOS Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
          fi
