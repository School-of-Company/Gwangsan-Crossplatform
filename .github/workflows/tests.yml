name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # test-android:
  #   name: Android E2E Test
  #   runs-on: macos-13
  #   timeout-minutes: 30

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'

  #     - name: Setup Android SDK
  #       uses: android-actions/setup-android@v3

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Install Maestro
  #       run: |
  #         curl -Ls "https://get.maestro.mobile.dev" | bash
  #         export PATH="$PATH:$HOME/.maestro/bin"
  #         maestro --version

  #     - name: Create Maestro environment
  #       run: |
  #         export PATH="$PATH:$HOME/.maestro/bin"
  #         echo "$HOME/.maestro/bin" >> $GITHUB_PATH

  #     - name: Kill stray ADB (once)
  #       run: |
  #         adb kill-server || true
  #         sleep 1
  #         adb start-server || true

  #     - name: Start Android Emulator
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         api-level: 33
  #         arch: x86_64
  #         target: google_apis
  #         profile: pixel_7
  #         avd-name: ci-avd
  #         force-avd-creation: true
  #         disable-animations: true
  #         emulator-options: >-
  #           -no-window -gpu swiftshader_indirect -no-boot-anim
  #           -no-snapshot -noaudio -camera-back none -camera-front none
  #         script: |
  #           set -e
  #           export PATH="$PATH:$HOME/.maestro/bin"
  #           echo "Device should already be booted by the action. Extra short wait..."
  #           adb wait-for-device
  #           adb shell getprop sys.boot_completed
  #           adb shell input keyevent 82 || true

  #           echo "Building app (Debug)‚Ä¶"
  #           npx expo prebuild --platform android --clean
  #           cd android
  #           ./gradlew --no-daemon assembleDebug

  #           APK_PATH=$(find . -name "app-debug.apk" -o -name "*-debug.apk" | head -1)
  #           if [ -z "$APK_PATH" ]; then
  #             APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
  #           fi
  #           if [ -z "$APK_PATH" ]; then
  #             echo "APK not found"
  #             exit 1
  #           fi

  #           echo "Installing APK: $APK_PATH"
  #           adb kill-server || true
  #           adb start-server || true
  #           adb wait-for-device
  #           adb install -r "$APK_PATH"

  #           echo "Run Maestro tests"
  #           cd ..
  #           maestro test maestro/user/*.yml

  #     - name: Upload Maestro test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: maestro-results-android
  #         path: |
  #           maestro/**/*.png
  #           maestro/**/*.mp4
  #         retention-days: 7

  test-ios:
    name: iOS E2E Test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: sudo gem install cocoapods -v 1.15.2

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Setup Xcode (pin)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Create & boot iOS Simulator (robust)
        id: simulator
        shell: bash
        run: |
          set -eu
          echo "== Show available runtimes/devices =="
          xcrun simctl list runtimes
          xcrun simctl list devices

          ALL_IOS_IDS=$(xcrun simctl list runtimes | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9]+-[0-9]+' || true)
          if [ -z "${ALL_IOS_IDS:-}" ]; then
            echo "No iOS runtimes installed."
            exit 1
          fi

          ALL_VERS=$(echo "$ALL_IOS_IDS" | sed -E 's/.*iOS-([0-9]+)-([0-9]+)/\1.\2/' | sort -V || true)
          BEST_VER=$(echo "$ALL_VERS" | tail -1 || true)

          if [ -z "${BEST_VER:-}" ]; then
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          else
            WANT=$(echo "$BEST_VER" | sed -E 's/([0-9]+)\.([0-9]+)/\1-\2/')
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | grep "iOS-${WANT}" | head -1 || true)
            [ -z "${RUNTIME_ID:-}" ] && RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          fi
          echo "Using runtime: $RUNTIME_ID"

          DEVICE_NAME="CI-iPhone-15"
          EXISTING=$(xcrun simctl list devices | grep "$DEVICE_NAME" | awk -F '[()]' '{print $2}' | head -1 || true)
          if [ -n "${EXISTING:-}" ]; then
            xcrun simctl delete "$EXISTING" || true
          fi

          SIM_ID=$(xcrun simctl create "$DEVICE_NAME" "iPhone 15" "$RUNTIME_ID")
          echo "Created simulator: $SIM_ID"

          xcrun simctl boot "$SIM_ID" || true
          xcrun simctl bootstatus "$SIM_ID" -b
          sleep 10

          echo "device_udid=$SIM_ID" >> "$GITHUB_OUTPUT"
          echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"

      - name: Prebuild iOS project
        run: |
          set -e
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: |
          set -e
          echo "Pods Ï∫êÏãú ÏßÄÏö∏Í≤å~"
          rm -rf Pods
          rm -f Podfile.lock
          rm -rf ~/Library/Caches/CocoaPods
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
          echo "Pods ÎÇâÏó¨Ïò§Í∏∞"
          pod install --repo-update
          
          if [ ! -d "Pods" ]; then
            echo "Error: Pods directory not found after installation"
            exit 1
          fi
          echo "Pods installed successfully"

      - name: Verify workspace setup
        working-directory: ios
        run: |
          set -e
          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: xcworkspace not found"
            exit 1
          fi
          
          echo "Workspace: $WORKSPACE_PATH"
          echo "Available schemes:"
          xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 20 "Schemes:" || true
          
          echo "Checking Pods structure..."
          if [ -d "Pods" ]; then
            echo "Pods directory exists"
            echo "Pods targets (first 20):"
            find Pods -name "*.modulemap" -o -name "*.podspec" | head -20 || true
          fi
          
          if [ -d "Pods/Pods.xcodeproj" ]; then
            echo "Pods.xcodeproj exists"
            echo "Listing Pods project targets:"
            xcodebuild -list -project "Pods/Pods.xcodeproj" 2>/dev/null | grep -A 50 "Targets:" || true
          fi
          
          echo "Checking Podfile configuration..."
          if [ -f "Podfile.properties.json" ]; then
            cat Podfile.properties.json
          fi

      - name: Build iOS app
        working-directory: ios
        run: |
          set -e
          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: xcworkspace not found"
            ls -la
            exit 1
          fi

          WORKSPACE_PATH=$(realpath "$WORKSPACE_PATH" || echo "$WORKSPACE_PATH")
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs || echo "app")

          DEVICE_UDID="${{ steps.simulator.outputs.device_udid }}"
          if [ -z "$DEVICE_UDID" ]; then
            echo "No simulator UDID from previous step"
            exit 1
          fi

          DERIVED_DATA_PATH="$HOME/Library/Developer/Xcode/DerivedData/ci-build"
          
          echo "Pre-build checks:"
          if [ -d "Pods" ]; then
            echo "‚úì Pods directory exists"
            POD_COUNT=$(find Pods -maxdepth 1 -type d -name "*" | wc -l | tr -d ' ')
            echo "  Found $POD_COUNT items in Pods directory"
          else
            echo "‚úó Pods directory not found"
            exit 1
          fi
          
          if [ -d "Pods/Pods.xcodeproj" ]; then
            echo "‚úì Pods.xcodeproj exists"
          else
            echo "‚úó Pods.xcodeproj not found"
            exit 1
          fi
          
          echo ""
          echo "Step 0: Verifying workspace structure and dependencies"
          echo "Checking if Pods are properly integrated in workspace..."
          
          if xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -q "Pods"; then
            echo "‚úì Pods found in workspace"
          else
            echo "‚ö† Pods not found in workspace schemes - this may cause dependency issues"
          fi
          
          if [ -f "app.xcodeproj/project.pbxproj" ]; then
            echo "Checking app target dependencies..."
            if grep -q "Pods-app" "app.xcodeproj/project.pbxproj" 2>/dev/null; then
              echo "‚úì Pods-app found in app project"
            else
              echo "‚ö† Pods-app may not be in app target dependencies"
            fi
          fi
          
          echo ""
          echo "Step 1: Building Pods dependencies via workspace to generate modulemaps and umbrella headers"
          echo "Building via workspace ensures proper framework structure with umbrella headers"
          
          if xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -q "Pods-app"; then
            echo "Building Pods-app scheme via workspace..."
            PODS_BUILD_EXIT=0
            xcodebuild -workspace "$WORKSPACE_PATH" \
              -scheme "Pods-app" \
              -configuration Debug \
              -sdk iphonesimulator \
              -destination "generic/platform=iOS Simulator" \
              -derivedDataPath "$DERIVED_DATA_PATH" \
              ARCHS="arm64 x86_64" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              ONLY_ACTIVE_ARCH=NO \
              -jobs 1 \
              build 2>&1 | tee /tmp/pods-build.log || PODS_BUILD_EXIT=$?
            
            if [ "$PODS_BUILD_EXIT" -ne 0 ]; then
              echo "Pods-app build failed with exit code $PODS_BUILD_EXIT"
              echo "Checking for errors in Pods build log:"
              grep -i "error:" /tmp/pods-build.log | head -30 || true
              echo "Will continue with app build - workspace may handle dependencies"
            else
              echo "Pods-app build completed successfully"
            fi
          elif [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            echo "Pods-app scheme not found, building Pods project directly..."
            PODS_BUILD_EXIT=0
            xcodebuild -project "Pods/Pods.xcodeproj" \
              -alltargets \
              -configuration Debug \
              -sdk iphonesimulator \
              -derivedDataPath "$DERIVED_DATA_PATH" \
              ARCHS="arm64 x86_64" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              ONLY_ACTIVE_ARCH=NO \
              -jobs 1 \
              build 2>&1 | tee /tmp/pods-build.log || PODS_BUILD_EXIT=$?
            
            if [ "$PODS_BUILD_EXIT" -ne 0 ]; then
              echo "Pods build failed with exit code $PODS_BUILD_EXIT"
              echo "Checking for errors in Pods build log:"
              grep -i "error:" /tmp/pods-build.log | head -30 || true
            else
              echo "Pods build completed successfully"
            fi
          else
            echo "No Pods project found"
          fi
            
            echo "Checking if modulemaps were generated..."
            MODULEMAP_DIR="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
            mkdir -p "$MODULEMAP_DIR"
            
            MODULEMAP_COUNT=$(find "$MODULEMAP_DIR" -name "*.modulemap" 2>/dev/null | wc -l | tr -d ' ')
            echo "Found $MODULEMAP_COUNT modulemaps in DerivedData after Pods build"
            
            UMBRELLA_COUNT=$(find "$MODULEMAP_DIR" -name "*-umbrella.h" 2>/dev/null | wc -l | tr -d ' ')
            echo "Found $UMBRELLA_COUNT umbrella headers in DerivedData after Pods build"
            
            echo "Checking for umbrella headers in built frameworks..."
            FRAMEWORKS_DIR="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
            
            find "$FRAMEWORKS_DIR" -name "*.framework" -type d 2>/dev/null | while read -r FRAMEWORK_PATH; do
              FRAMEWORK_NAME=$(basename "$FRAMEWORK_PATH" .framework)
              HEADERS_DIR="$FRAMEWORK_PATH/Headers"
              UMBRELLA_HEADER="$HEADERS_DIR/${FRAMEWORK_NAME}-umbrella.h"
              
              if [ -f "$UMBRELLA_HEADER" ]; then
                MODULE_DIR="$MODULEMAP_DIR/$FRAMEWORK_NAME"
                mkdir -p "$MODULE_DIR"
                cp "$UMBRELLA_HEADER" "$MODULE_DIR/"
                echo "  Copied $FRAMEWORK_NAME-umbrella.h to $MODULE_DIR/"
              fi
            done
            
            PODS_BUILD_DIR="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
            find "$PODS_BUILD_DIR" -name "*.framework" -type d 2>/dev/null | while read -r FRAMEWORK_PATH; do
              FRAMEWORK_NAME=$(basename "$FRAMEWORK_PATH" .framework)
              HEADERS_DIR="$FRAMEWORK_PATH/Headers"
              UMBRELLA_HEADER="$HEADERS_DIR/${FRAMEWORK_NAME}-umbrella.h"
              
              if [ -f "$UMBRELLA_HEADER" ]; then
                MODULE_DIR="$MODULEMAP_DIR/$FRAMEWORK_NAME"
                mkdir -p "$MODULE_DIR"
                cp "$UMBRELLA_HEADER" "$MODULE_DIR/"
                echo "  Copied $FRAMEWORK_NAME-umbrella.h from Pods build to $MODULE_DIR/"
              fi
            done
            
            echo "Creating missing umbrella headers for modules..."
            find "$MODULEMAP_DIR" -name "*.modulemap" -type f 2>/dev/null | while read -r MODULEMAP_FILE; do
              MODULE_DIR=$(dirname "$MODULEMAP_FILE")
              MODULE_NAME=$(basename "$MODULE_DIR")
              UMBRELLA_HEADER="$MODULE_DIR/${MODULE_NAME}-umbrella.h"
              
              if [ ! -f "$UMBRELLA_HEADER" ]; then
                PODS_HEADERS="Pods/Headers/Public/$MODULE_NAME"
                if [ ! -d "$PODS_HEADERS" ]; then
                  case "$MODULE_NAME" in
                    EXDevLauncher)
                      PODS_HEADERS="Pods/Headers/Public/expo-dev-launcher"
                      ;;
                    EXDevMenuInterface)
                      PODS_HEADERS="Pods/Headers/Public/expo-dev-menu-interface"
                      ;;
                    EXDevMenu)
                      PODS_HEADERS="Pods/Headers/Public/expo-dev-menu"
                      ;;
                  esac
                fi
                
                if [ -d "$PODS_HEADERS" ]; then
                  echo "  Creating ${MODULE_NAME}-umbrella.h from Pods headers..."
                  {
                    echo "#ifdef __OBJC__"
                    echo "#import <Foundation/Foundation.h>"
                    echo "#else"
                    echo "#ifndef FOUNDATION_EXPORT"
                    echo "#if defined(__cplusplus)"
                    echo "#define FOUNDATION_EXPORT extern \"C\""
                    echo "#else"
                    echo "#define FOUNDATION_EXPORT extern"
                    echo "#endif"
                    echo "#endif"
                    echo "#endif"
                    find "$PODS_HEADERS" -name "*.h" -type f | while read -r HEADER; do
                      HEADER_NAME=$(basename "$HEADER")
                      echo "#import <$MODULE_NAME/$HEADER_NAME>"
                    done
                  } > "$UMBRELLA_HEADER"
                  echo "    Created ${MODULE_NAME}-umbrella.h"
                fi
              fi
            done
            
            if [ -f "$MODULEMAP_DIR/Expo/Expo-umbrella.h" ]; then
              echo "‚úì Expo-umbrella.h found"
            else
              echo "‚ö† Expo-umbrella.h NOT found after creation attempt"
            fi
            
            if [ "$MODULEMAP_COUNT" -eq 0 ]; then
              echo "No modulemaps in DerivedData - Pods are built as static libraries"
              echo "Copying modulemaps from Pods/Target Support Files to DerivedData..."
              
              find "Pods/Target Support Files" -name "*.modulemap" 2>/dev/null | while read -r MODULEMAP_PATH; do
                POD_DIR=$(basename "$(dirname "$MODULEMAP_PATH")")
                MODULEMAP_FILE=$(basename "$MODULEMAP_PATH")
                
                if [ "$POD_DIR" = "Pods-app" ]; then
                  continue
                fi
                
                ACTUAL_MODULE_NAME=$(grep -E "^module\s+\S+" "$MODULEMAP_PATH" 2>/dev/null | head -1 | awk '{print $2}' | tr -d ';' || echo "$POD_DIR")
                
                if [ -z "$ACTUAL_MODULE_NAME" ] || [ "$ACTUAL_MODULE_NAME" = "$POD_DIR" ]; then
                  ACTUAL_MODULE_NAME=$(echo "$MODULEMAP_FILE" | sed 's/\.modulemap$//')
                fi
                
                case "$POD_DIR" in
                  expo-dev-launcher)
                    ACTUAL_MODULE_NAME="EXDevLauncher"
                    ;;
                  expo-dev-menu-interface)
                    ACTUAL_MODULE_NAME="EXDevMenuInterface"
                    ;;
                  expo-dev-menu)
                    ACTUAL_MODULE_NAME="EXDevMenu"
                    ;;
                esac
                
                MODULE_DIR="$MODULEMAP_DIR/$ACTUAL_MODULE_NAME"
                mkdir -p "$MODULE_DIR"
                cp "$MODULEMAP_PATH" "$MODULE_DIR/$ACTUAL_MODULE_NAME.modulemap"
                echo "  Copied $POD_DIR -> $ACTUAL_MODULE_NAME/$ACTUAL_MODULE_NAME.modulemap"
                
                if [ "$POD_DIR" != "$ACTUAL_MODULE_NAME" ]; then
                  POD_MODULE_DIR="$MODULEMAP_DIR/$POD_DIR"
                  mkdir -p "$POD_MODULE_DIR"
                  cp "$MODULEMAP_PATH" "$POD_MODULE_DIR/$ACTUAL_MODULE_NAME.modulemap"
                  echo "  Copied $POD_DIR -> $POD_DIR/$ACTUAL_MODULE_NAME.modulemap"
                fi
              done
              
              MODULEMAP_COUNT_AFTER=$(find "$MODULEMAP_DIR" -name "*.modulemap" 2>/dev/null | wc -l | tr -d ' ')
              echo "‚úì Copied $MODULEMAP_COUNT_AFTER modulemaps to DerivedData"
              
              echo "Sample of copied modulemaps:"
              find "$MODULEMAP_DIR" -name "*.modulemap" 2>/dev/null | head -10 || true
            else
              echo "‚úì Modulemaps found in DerivedData - ready for app build"
            fi
          else
            echo "Pods project not found at $PODS_PROJECT"
          fi
          
          echo "Using -jobs 1 to ensure sequential build order"

          xcodebuild -workspace "$WORKSPACE_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=$DEVICE_UDID" \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            ARCHS="arm64 x86_64" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            -jobs 1 \
            build 2>&1 | tee /tmp/xcodebuild.log
            
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          if grep -qi "module map file.*not found\|no such module" /tmp/xcodebuild.log; then
            echo "ERROR: Module import errors detected - build cannot succeed"
            echo "This indicates Pods dependencies were not built correctly"
            echo ""
            echo "Module errors:"
            grep -i "module map file.*not found\|no such module" /tmp/xcodebuild.log | head -30 || true
            echo ""
            echo "Debugging information:"
            echo "1. Checking DerivedData structure:"
            MODULEMAP_DIR="$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator"
            if [ -d "$MODULEMAP_DIR" ]; then
              echo "Directory exists: $MODULEMAP_DIR"
              ls -la "$MODULEMAP_DIR" | head -20 || true
            else
              echo "Directory does not exist: $MODULEMAP_DIR"
            fi
            echo ""
            echo "2. Searching for any modulemaps:"
            find "$DERIVED_DATA_PATH" -name "*.modulemap" 2>/dev/null | head -20 || echo "No modulemaps found anywhere"
            echo ""
            echo "3. Checking Pods structure:"
            if [ -d "Pods" ]; then
              echo "Pods directory exists"
              find Pods -name "*.modulemap" 2>/dev/null | head -10 || echo "No modulemaps in Pods"
            fi
            echo ""
            echo "4. Checking build log for Pods build information:"
            grep -i "pods\|dependency" /tmp/xcodebuild.log | head -20 || true
            echo ""
            echo "Build will fail due to module errors"
            exit 1
          fi
          
          if [ "$BUILD_EXIT_CODE" -ne 0 ]; then
            echo "Build failed with exit code $BUILD_EXIT_CODE"
            echo "Swift/compilation errors:"
            grep -i "error:" /tmp/xcodebuild.log | grep -v "note:" | head -30 || true
            echo "Checking DerivedData structure:"
            find "$DERIVED_DATA_PATH/Build/Products/Debug-iphonesimulator" -type d -maxdepth 2 2>/dev/null | head -20 || true
            exit 1
          fi
          
          if grep -qi "BUILD FAILED\|failed with a nonzero exit code" /tmp/xcodebuild.log; then
            echo "WARNING: Build failures detected in log"
            grep -i "BUILD FAILED\|failed with a nonzero exit code" /tmp/xcodebuild.log | head -10 || true
            exit 1
          fi

      - name: Verify app bundle
        working-directory: ios
        run: |
          set -e
          DERIVED_DATA_PATH="$HOME/Library/Developer/Xcode/DerivedData/ci-build"
          
          APP_PATH=$(find "$DERIVED_DATA_PATH" -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          if [ -z "$APP_PATH" ]; then
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi

          if [ -z "$APP_PATH" ]; then
            echo "Error: App not found in build output"
            echo "Searching in: $DERIVED_DATA_PATH"
            find "$DERIVED_DATA_PATH" -name "*.app" 2>/dev/null | head -10 || true
            exit 1
          fi
          
          echo "Found app at: $APP_PATH"
          echo "Verifying app bundle structure..."
          
          APP_NAME=$(basename "$APP_PATH" .app)
          EXECUTABLE_PATH="$APP_PATH/$APP_NAME"
          
          if [ ! -f "$EXECUTABLE_PATH" ]; then
            echo "ERROR: Executable not found at expected path: $EXECUTABLE_PATH"
            echo "App bundle contents:"
            ls -la "$APP_PATH" || true
            echo "Looking for any executable files:"
            find "$APP_PATH" -type f -perm +111 2>/dev/null || true
            echo "Checking Info.plist for executable name:"
            if [ -f "$APP_PATH/Info.plist" ]; then
              /usr/libexec/PlistBuddy -c "Print :CFBundleExecutable" "$APP_PATH/Info.plist" 2>/dev/null || true
            fi
            exit 1
          fi
          
          if [ ! -x "$EXECUTABLE_PATH" ]; then
            echo "ERROR: Executable exists but is not executable"
            ls -la "$EXECUTABLE_PATH"
            exit 1
          fi
          
          echo "App bundle verification successful"
          echo "Executable: $EXECUTABLE_PATH"
          echo "Executable size: $(stat -f%z "$EXECUTABLE_PATH" 2>/dev/null || stat -c%s "$EXECUTABLE_PATH" 2>/dev/null) bytes"
          file "$EXECUTABLE_PATH" || true

      - name: Install app on simulator
        working-directory: ios
        run: |
          set -e
          DERIVED_DATA_PATH="$HOME/Library/Developer/Xcode/DerivedData/ci-build"
          
          APP_PATH=$(find "$DERIVED_DATA_PATH" -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi
          
          if [ -z "$APP_PATH" ]; then
            echo "Error: App not found"
            exit 1
          fi
          
          echo "Installing app: $APP_PATH"
          xcrun simctl install booted "$APP_PATH"

      - name: Run Maestro tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [test-ios]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not set, skipping notification"
            exit 0
          fi

          IOS_STATUS="${{ needs.test-ios.result }}"

          if [ "$IOS_STATUS" == "success" ] || [ "$IOS_STATUS" == "skipped" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="‚ùå"
            STATUS="Ïã§Ìå®"
          fi

          EMBED=$(cat <<EOF
          {
            "title": "$EMOJI Maestro ÌÖåÏä§Ìä∏ $STATUS",
            "color": $COLOR,
            "fields": [
              {"name": "iOS", "value": "$IOS_STATUS", "inline": true},
              {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[Î≥¥Í∏∞]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)", "inline": false}
            ]
          }
          EOF
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [$EMBED]}"

          if [ "$STATUS" == "Ïã§Ìå®" ]; then
            IOS_SCREENSHOT=$(find maestro-results-ios -name "*.png" 2>/dev/null | head -1)
            
            [ -n "$IOS_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$IOS_SCREENSHOT" -F "content=üçé iOS Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
          fi
      - name: Xcode/SDK info
        run: |
          xcodebuild -version
          xcodebuild -showsdks
          xcrun simctl list

      - name: Print DerivedData products
        if: failure()
        run: |
          find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "*.app" -print
