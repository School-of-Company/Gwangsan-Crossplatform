name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # test-android:
  #   name: Android E2E Test
  #   runs-on: macos-13
  #   timeout-minutes: 30

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'

  #     - name: Setup Android SDK
  #       uses: android-actions/setup-android@v3

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Install Maestro
  #       run: |
  #         curl -Ls "https://get.maestro.mobile.dev" | bash
  #         export PATH="$PATH:$HOME/.maestro/bin"
  #         maestro --version

  #     - name: Create Maestro environment
  #       run: |
  #         export PATH="$PATH:$HOME/.maestro/bin"
  #         echo "$HOME/.maestro/bin" >> $GITHUB_PATH

  #     - name: Kill stray ADB (once)
  #       run: |
  #         adb kill-server || true
  #         sleep 1
  #         adb start-server || true

  #     - name: Start Android Emulator
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         api-level: 33
  #         arch: x86_64
  #         target: google_apis
  #         profile: pixel_7
  #         avd-name: ci-avd
  #         force-avd-creation: true
  #         disable-animations: true
  #         emulator-options: >-
  #           -no-window -gpu swiftshader_indirect -no-boot-anim
  #           -no-snapshot -noaudio -camera-back none -camera-front none
  #         script: |
  #           set -e
  #           export PATH="$PATH:$HOME/.maestro/bin"
  #           echo "Device should already be booted by the action. Extra short wait..."
  #           adb wait-for-device
  #           adb shell getprop sys.boot_completed
  #           adb shell input keyevent 82 || true

  #           echo "Building app (Debug)‚Ä¶"
  #           npx expo prebuild --platform android --clean
  #           cd android
  #           ./gradlew --no-daemon assembleDebug

  #           APK_PATH=$(find . -name "app-debug.apk" -o -name "*-debug.apk" | head -1)
  #           if [ -z "$APK_PATH" ]; then
  #             APK_PATH=$(find . -name "*.apk" -path "*/debug/*" | head -1)
  #           fi
  #           if [ -z "$APK_PATH" ]; then
  #             echo "APK not found"
  #             exit 1
  #           fi

  #           echo "Installing APK: $APK_PATH"
  #           adb kill-server || true
  #           adb start-server || true
  #           adb wait-for-device
  #           adb install -r "$APK_PATH"

  #           echo "Run Maestro tests"
  #           cd ..
  #           maestro test maestro/user/*.yml

  #     - name: Upload Maestro test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: maestro-results-android
  #         path: |
  #           maestro/**/*.png
  #           maestro/**/*.mp4
  #         retention-days: 7

  test-ios:
    name: iOS E2E Test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: sudo gem install cocoapods -v 1.15.2

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      - name: Create Maestro environment
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Setup Xcode (pin)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.1'

      - name: Create & boot iOS Simulator (robust)
        id: simulator
        shell: bash
        run: |
          set -eu
          echo "== Show available runtimes/devices =="
          xcrun simctl list runtimes
          xcrun simctl list devices

          ALL_IOS_IDS=$(xcrun simctl list runtimes | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9]+-[0-9]+' || true)
          if [ -z "${ALL_IOS_IDS:-}" ]; then
            echo "No iOS runtimes installed."
            exit 1
          fi

          ALL_VERS=$(echo "$ALL_IOS_IDS" | sed -E 's/.*iOS-([0-9]+)-([0-9]+)/\1.\2/' | sort -V || true)
          BEST_VER=$(echo "$ALL_VERS" | tail -1 || true)

          if [ -z "${BEST_VER:-}" ]; then
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          else
            WANT=$(echo "$BEST_VER" | sed -E 's/([0-9]+)\.([0-9]+)/\1-\2/')
            RUNTIME_ID=$(echo "$ALL_IOS_IDS" | grep "iOS-${WANT}" | head -1 || true)
            [ -z "${RUNTIME_ID:-}" ] && RUNTIME_ID=$(echo "$ALL_IOS_IDS" | tail -1)
          fi
          echo "Using runtime: $RUNTIME_ID"

          DEVICE_NAME="CI-iPhone-15"
          EXISTING=$(xcrun simctl list devices | grep "$DEVICE_NAME" | awk -F '[()]' '{print $2}' | head -1 || true)
          if [ -n "${EXISTING:-}" ]; then
            xcrun simctl delete "$EXISTING" || true
          fi

          SIM_ID=$(xcrun simctl create "$DEVICE_NAME" "iPhone 15" "$RUNTIME_ID")
          echo "Created simulator: $SIM_ID"

          xcrun simctl boot "$SIM_ID" || true
          xcrun simctl bootstatus "$SIM_ID" -b
          sleep 10

          echo "device_udid=$SIM_ID" >> "$GITHUB_OUTPUT"
          echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"

      - name: Build and install iOS app
        run: |
          set -e
          
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
          npx expo prebuild --platform ios --clean
          cd ios

          pod repo update
          pod install

          if [ ! -d "Pods" ]; then
            echo "Error: Pods directory not found after installation"
            exit 1
          fi

          WORKSPACE_PATH=$(find . -name "*.xcworkspace" -type d | head -1)
          if [ -z "$WORKSPACE_PATH" ]; then
            echo "Error: xcworkspace not found"
            ls -la
            exit 1
          fi

          WORKSPACE_PATH=$(realpath "$WORKSPACE_PATH" || echo "$WORKSPACE_PATH")
          WORKSPACE=$(basename "$WORKSPACE_PATH" .xcworkspace)
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE_PATH" 2>/dev/null | grep -A 10 "Schemes:" | grep -v "Schemes:" | head -1 | xargs || echo "$WORKSPACE")

          echo "Found workspace: $WORKSPACE_PATH"

          DEVICE_UDID="${{ steps.simulator.outputs.device_udid }}"
          if [ -z "$DEVICE_UDID" ]; then
            echo "No simulator UDID from previous step"
            exit 1
          fi

          DERIVED_DATA_PATH="$HOME/Library/Developer/Xcode/DerivedData/ci-build"
          mkdir -p "$DERIVED_DATA_PATH"

          echo "Building workspace: $WORKSPACE_PATH, scheme: $SCHEME, destination: $DEVICE_UDID"

          xcodebuild -workspace "$WORKSPACE_PATH" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=$DEVICE_UDID" \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            ARCHS="arm64 x86_64" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            build

          APP_PATH=$(find "$DERIVED_DATA_PATH" -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi
          if [ -z "$APP_PATH" ]; then
            APP_PATH=$(find . -name "*.app" -path "*/Build/Products/Debug-iphonesimulator/*" | head -1)
          fi

          if [ -n "$APP_PATH" ]; then
            echo "Installing app: $APP_PATH"
            xcrun simctl install booted "$APP_PATH"
          else
            echo "Error: App not found in build output"
            exit 1
          fi

      - name: Run Maestro tests
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro test maestro/user/*.yml

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results-ios
          path: |
            maestro/**/*.png
            maestro/**/*.mp4
          retention-days: 7

  notify-discord:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [test-ios]
    if: always()
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Discord webhook URL not set, skipping notification"
            exit 0
          fi

          IOS_STATUS="${{ needs.test-ios.result }}"

          if [ "$IOS_STATUS" == "success" ] || [ "$IOS_STATUS" == "skipped" ]; then
            COLOR=3066993
            EMOJI="‚úÖ"
            STATUS="ÏÑ±Í≥µ"
          else
            COLOR=15158332
            EMOJI="‚ùå"
            STATUS="Ïã§Ìå®"
          fi

          EMBED=$(cat <<EOF
          {
            "title": "$EMOJI Maestro ÌÖåÏä§Ìä∏ $STATUS",
            "color": $COLOR,
            "fields": [
              {"name": "iOS", "value": "$IOS_STATUS", "inline": true},
              {"name": "ÏõåÌÅ¨ÌîåÎ°úÏö∞", "value": "[Î≥¥Í∏∞]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)", "inline": false}
            ]
          }
          EOF
          )

          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [$EMBED]}"

          if [ "$STATUS" == "Ïã§Ìå®" ]; then
            IOS_SCREENSHOT=$(find maestro-results-ios -name "*.png" 2>/dev/null | head -1)
            
            [ -n "$IOS_SCREENSHOT" ] && curl -X POST "$DISCORD_WEBHOOK_URL" \
              -F "file=@$IOS_SCREENSHOT" -F "content=üçé iOS Ïã§Ìå® Ïä§ÌÅ¨Î¶∞ÏÉ∑"
          fi
      - name: Xcode/SDK info
        run: |
          xcodebuild -version
          xcodebuild -showsdks
          xcrun simctl list

      - name: Print DerivedData products
        if: failure()
        run: |
          find ~/Library/Developer/Xcode/DerivedData -maxdepth 4 -type d -name "*.app" -print
